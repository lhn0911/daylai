<template>
  <div class="change-password-container">
    <h2 class="heading">Đổi mật khẩu</h2>
    <p class="description">
      Hãy nhập mật khẩu hiện tại của bạn để thay đổi mật khẩu mới.
    </p>

    <form @submit.prevent="handleChangePassword" class="form">
      <!-- Current Password -->
      <div class="form-group">
        <label for="currentPassword" class="label">Mật khẩu hiện tại</label>
        <div class="input-wrapper">
          <input
            id="currentPassword"
            :type="showCurrentPassword ? 'text' : 'password'"
            v-model="currentPassword"
            class="input"
            required
          />
          <button
            type="button"
            @click="showCurrentPassword = !showCurrentPassword"
            class="toggle-password-btn"
          >
            <svg
              v-if="showCurrentPassword"
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M7.99995 10.8867C6.40661 10.8867 5.11328 9.59334 5.11328 8.00001C5.11328 6.40668 6.40661 5.11334 7.99995 5.11334C9.59328 5.11334 10.8866 6.40668 10.8866 8.00001C10.8866 9.59334 9.59328 10.8867 7.99995 10.8867ZM7.99995 6.11334C6.95995 6.11334 6.11328 6.96001 6.11328 8.00001C6.11328 9.04001 6.95995 9.88668 7.99995 9.88668C9.03995 9.88668 9.88661 9.04001 9.88661 8.00001C9.88661 6.96001 9.03995 6.11334 7.99995 6.11334Z"
                fill="#2D2C2C"
              />
              <path
                d="M8.0007 14.0133C5.49404 14.0133 3.12737 12.5467 1.5007 10C0.794036 8.9 0.794036 7.10666 1.5007 6C3.13404 3.45333 5.5007 1.98666 8.0007 1.98666C10.5007 1.98666 12.8674 3.45333 14.494 6C15.2007 7.1 15.2007 8.89333 14.494 10C12.8674 12.5467 10.5007 14.0133 8.0007 14.0133ZM8.0007 2.98666C5.84737 2.98666 3.78737 4.28 2.34737 6.54C1.84737 7.32 1.84737 8.68 2.34737 9.46C3.78737 11.72 5.84737 13.0133 8.0007 13.0133C10.154 13.0133 12.214 11.72 13.654 9.46C14.154 8.68 14.154 7.32 13.654 6.54C12.214 4.28 10.154 2.98666 8.0007 2.98666Z"
                fill="#2D2C2C"
              />
            </svg>

            <svg
              v-else
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6.31328 10.1867C6.18661 10.1867 6.05995 10.14 5.95995 10.04C5.41328 9.49334 5.11328 8.76668 5.11328 8.00001C5.11328 6.40668 6.40661 5.11334 7.99995 5.11334C8.76661 5.11334 9.49328 5.41334 10.0399 5.96001C10.1333 6.05334 10.1866 6.18001 10.1866 6.31334C10.1866 6.44668 10.1333 6.57334 10.0399 6.66668L6.66661 10.04C6.56661 10.14 6.43995 10.1867 6.31328 10.1867ZM7.99995 6.11334C6.95995 6.11334 6.11328 6.96001 6.11328 8.00001C6.11328 8.33334 6.19995 8.65334 6.35995 8.93334L8.93328 6.36001C8.65328 6.20001 8.33328 6.11334 7.99995 6.11334Z"
                fill="#2D2C2C"
              />
              <path
                d="M3.73323 12.34C3.6199 12.34 3.4999 12.3 3.40656 12.22C2.69323 11.6133 2.05323 10.8667 1.50656 10C0.799896 8.9 0.799896 7.10666 1.50656 6C3.13323 3.45333 5.4999 1.98666 7.9999 1.98666C9.46656 1.98666 10.9132 2.49333 12.1799 3.44666C12.3999 3.61333 12.4466 3.92666 12.2799 4.14666C12.1132 4.36666 11.7999 4.41333 11.5799 4.24666C10.4866 3.42 9.24656 2.98666 7.9999 2.98666C5.84656 2.98666 3.78656 4.28 2.34656 6.54C1.84656 7.32 1.84656 8.68 2.34656 9.46C2.84656 10.24 3.4199 10.9133 4.05323 11.46C4.2599 11.64 4.28656 11.9533 4.10656 12.1667C4.01323 12.28 3.87323 12.34 3.73323 12.34Z"
                fill="#2D2C2C"
              />
              <path
                d="M7.99972 14.0133C7.11305 14.0133 6.24638 13.8333 5.41305 13.48C5.15972 13.3733 5.03972 13.08 5.14638 12.8267C5.25305 12.5733 5.54638 12.4533 5.79972 12.56C6.50638 12.86 7.24638 13.0133 7.99305 13.0133C10.1464 13.0133 12.2064 11.72 13.6464 9.45999C14.1464 8.67999 14.1464 7.31999 13.6464 6.53999C13.4397 6.21332 13.213 5.89999 12.973 5.60666C12.7997 5.39332 12.833 5.07999 13.0464 4.89999C13.2597 4.72666 13.573 4.75332 13.753 4.97332C14.013 5.29332 14.2664 5.63999 14.493 5.99999C15.1997 7.09999 15.1997 8.89332 14.493 9.99999C12.8664 12.5467 10.4997 14.0133 7.99972 14.0133Z"
                fill="#2D2C2C"
              />
              <path
                d="M8.45973 10.8467C8.22639 10.8467 8.01306 10.68 7.96639 10.44C7.91306 10.1667 8.09306 9.90665 8.36639 9.85999C9.09973 9.72665 9.71306 9.11332 9.8464 8.37999C9.89973 8.10665 10.1597 7.93332 10.4331 7.97999C10.7064 8.03332 10.8864 8.29332 10.8331 8.56665C10.6197 9.71999 9.69973 10.6333 8.55306 10.8467C8.51973 10.84 8.49306 10.8467 8.45973 10.8467Z"
                fill="#292D32"
              />
              <path
                d="M1.33427 15.1667C1.2076 15.1667 1.08094 15.12 0.980938 15.02C0.787604 14.8267 0.787604 14.5067 0.980938 14.3133L5.96094 9.33332C6.15427 9.13999 6.47427 9.13999 6.6676 9.33332C6.86094 9.52666 6.86094 9.84666 6.6676 10.04L1.6876 15.02C1.5876 15.12 1.46094 15.1667 1.33427 15.1667Z"
                fill="#292D32"
              />
              <path
                d="M9.68583 6.81333C9.55917 6.81333 9.4325 6.76666 9.3325 6.66666C9.13917 6.47333 9.13917 6.15332 9.3325 5.95999L14.3125 0.979991C14.5058 0.786658 14.8258 0.786658 15.0192 0.979991C15.2125 1.17332 15.2125 1.49332 15.0192 1.68666L10.0392 6.66666C9.93917 6.76666 9.8125 6.81333 9.68583 6.81333Z"
                fill="#292D32"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- New Password -->
      <div class="form-group">
        <label for="newPassword" class="label">Mật khẩu mới</label>
        <div class="input-wrapper">
          <input
            id="newPassword"
            :type="showNewPassword ? 'text' : 'password'"
            v-model="newPassword"
            class="input"
            required
          />
          <button
            type="button"
            @click="showNewPassword = !showNewPassword"
            class="toggle-password-btn"
          >
            <svg
              v-if="showNewPassword"
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M7.99995 10.8867C6.40661 10.8867 5.11328 9.59334 5.11328 8.00001C5.11328 6.40668 6.40661 5.11334 7.99995 5.11334C9.59328 5.11334 10.8866 6.40668 10.8866 8.00001C10.8866 9.59334 9.59328 10.8867 7.99995 10.8867ZM7.99995 6.11334C6.95995 6.11334 6.11328 6.96001 6.11328 8.00001C6.11328 9.04001 6.95995 9.88668 7.99995 9.88668C9.03995 9.88668 9.88661 9.04001 9.88661 8.00001C9.88661 6.96001 9.03995 6.11334 7.99995 6.11334Z"
                fill="#2D2C2C"
              />
              <path
                d="M8.0007 14.0133C5.49404 14.0133 3.12737 12.5467 1.5007 10C0.794036 8.9 0.794036 7.10666 1.5007 6C3.13404 3.45333 5.5007 1.98666 8.0007 1.98666C10.5007 1.98666 12.8674 3.45333 14.494 6C15.2007 7.1 15.2007 8.89333 14.494 10C12.8674 12.5467 10.5007 14.0133 8.0007 14.0133ZM8.0007 2.98666C5.84737 2.98666 3.78737 4.28 2.34737 6.54C1.84737 7.32 1.84737 8.68 2.34737 9.46C3.78737 11.72 5.84737 13.0133 8.0007 13.0133C10.154 13.0133 12.214 11.72 13.654 9.46C14.154 8.68 14.154 7.32 13.654 6.54C12.214 4.28 10.154 2.98666 8.0007 2.98666Z"
                fill="#2D2C2C"
              />
            </svg>

            <svg
              v-else
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6.31328 10.1867C6.18661 10.1867 6.05995 10.14 5.95995 10.04C5.41328 9.49334 5.11328 8.76668 5.11328 8.00001C5.11328 6.40668 6.40661 5.11334 7.99995 5.11334C8.76661 5.11334 9.49328 5.41334 10.0399 5.96001C10.1333 6.05334 10.1866 6.18001 10.1866 6.31334C10.1866 6.44668 10.1333 6.57334 10.0399 6.66668L6.66661 10.04C6.56661 10.14 6.43995 10.1867 6.31328 10.1867ZM7.99995 6.11334C6.95995 6.11334 6.11328 6.96001 6.11328 8.00001C6.11328 8.33334 6.19995 8.65334 6.35995 8.93334L8.93328 6.36001C8.65328 6.20001 8.33328 6.11334 7.99995 6.11334Z"
                fill="#2D2C2C"
              />
              <path
                d="M3.73323 12.34C3.6199 12.34 3.4999 12.3 3.40656 12.22C2.69323 11.6133 2.05323 10.8667 1.50656 10C0.799896 8.9 0.799896 7.10666 1.50656 6C3.13323 3.45333 5.4999 1.98666 7.9999 1.98666C9.46656 1.98666 10.9132 2.49333 12.1799 3.44666C12.3999 3.61333 12.4466 3.92666 12.2799 4.14666C12.1132 4.36666 11.7999 4.41333 11.5799 4.24666C10.4866 3.42 9.24656 2.98666 7.9999 2.98666C5.84656 2.98666 3.78656 4.28 2.34656 6.54C1.84656 7.32 1.84656 8.68 2.34656 9.46C2.84656 10.24 3.4199 10.9133 4.05323 11.46C4.2599 11.64 4.28656 11.9533 4.10656 12.1667C4.01323 12.28 3.87323 12.34 3.73323 12.34Z"
                fill="#2D2C2C"
              />
              <path
                d="M7.99972 14.0133C7.11305 14.0133 6.24638 13.8333 5.41305 13.48C5.15972 13.3733 5.03972 13.08 5.14638 12.8267C5.25305 12.5733 5.54638 12.4533 5.79972 12.56C6.50638 12.86 7.24638 13.0133 7.99305 13.0133C10.1464 13.0133 12.2064 11.72 13.6464 9.45999C14.1464 8.67999 14.1464 7.31999 13.6464 6.53999C13.4397 6.21332 13.213 5.89999 12.973 5.60666C12.7997 5.39332 12.833 5.07999 13.0464 4.89999C13.2597 4.72666 13.573 4.75332 13.753 4.97332C14.013 5.29332 14.2664 5.63999 14.493 5.99999C15.1997 7.09999 15.1997 8.89332 14.493 9.99999C12.8664 12.5467 10.4997 14.0133 7.99972 14.0133Z"
                fill="#2D2C2C"
              />
              <path
                d="M8.45973 10.8467C8.22639 10.8467 8.01306 10.68 7.96639 10.44C7.91306 10.1667 8.09306 9.90665 8.36639 9.85999C9.09973 9.72665 9.71306 9.11332 9.8464 8.37999C9.89973 8.10665 10.1597 7.93332 10.4331 7.97999C10.7064 8.03332 10.8864 8.29332 10.8331 8.56665C10.6197 9.71999 9.69973 10.6333 8.55306 10.8467C8.51973 10.84 8.49306 10.8467 8.45973 10.8467Z"
                fill="#292D32"
              />
              <path
                d="M1.33427 15.1667C1.2076 15.1667 1.08094 15.12 0.980938 15.02C0.787604 14.8267 0.787604 14.5067 0.980938 14.3133L5.96094 9.33332C6.15427 9.13999 6.47427 9.13999 6.6676 9.33332C6.86094 9.52666 6.86094 9.84666 6.6676 10.04L1.6876 15.02C1.5876 15.12 1.46094 15.1667 1.33427 15.1667Z"
                fill="#292D32"
              />
              <path
                d="M9.68583 6.81333C9.55917 6.81333 9.4325 6.76666 9.3325 6.66666C9.13917 6.47333 9.13917 6.15332 9.3325 5.95999L14.3125 0.979991C14.5058 0.786658 14.8258 0.786658 15.0192 0.979991C15.2125 1.17332 15.2125 1.49332 15.0192 1.68666L10.0392 6.66666C9.93917 6.76666 9.8125 6.81333 9.68583 6.81333Z"
                fill="#292D32"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- Confirm New Password -->
      <div class="form-group">
        <label for="confirmPassword" class="label">Xác nhận mật khẩu mới</label>
        <div class="input-wrapper">
          <input
            id="confirmPassword"
            :type="showConfirmPassword ? 'text' : 'password'"
            v-model="confirmPassword"
            class="input"
            required
          />
          <button
            type="button"
            @click="showConfirmPassword = !showConfirmPassword"
            class="toggle-password-btn"
          >
            <svg
              v-if="showConfirmPassword"
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M7.99995 10.8867C6.40661 10.8867 5.11328 9.59334 5.11328 8.00001C5.11328 6.40668 6.40661 5.11334 7.99995 5.11334C9.59328 5.11334 10.8866 6.40668 10.8866 8.00001C10.8866 9.59334 9.59328 10.8867 7.99995 10.8867ZM7.99995 6.11334C6.95995 6.11334 6.11328 6.96001 6.11328 8.00001C6.11328 9.04001 6.95995 9.88668 7.99995 9.88668C9.03995 9.88668 9.88661 9.04001 9.88661 8.00001C9.88661 6.96001 9.03995 6.11334 7.99995 6.11334Z"
                fill="#2D2C2C"
              />
              <path
                d="M8.0007 14.0133C5.49404 14.0133 3.12737 12.5467 1.5007 10C0.794036 8.9 0.794036 7.10666 1.5007 6C3.13404 3.45333 5.5007 1.98666 8.0007 1.98666C10.5007 1.98666 12.8674 3.45333 14.494 6C15.2007 7.1 15.2007 8.89333 14.494 10C12.8674 12.5467 10.5007 14.0133 8.0007 14.0133ZM8.0007 2.98666C5.84737 2.98666 3.78737 4.28 2.34737 6.54C1.84737 7.32 1.84737 8.68 2.34737 9.46C3.78737 11.72 5.84737 13.0133 8.0007 13.0133C10.154 13.0133 12.214 11.72 13.654 9.46C14.154 8.68 14.154 7.32 13.654 6.54C12.214 4.28 10.154 2.98666 8.0007 2.98666Z"
                fill="#2D2C2C"
              />
            </svg>

            <svg
              v-else
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6.31328 10.1867C6.18661 10.1867 6.05995 10.14 5.95995 10.04C5.41328 9.49334 5.11328 8.76668 5.11328 8.00001C5.11328 6.40668 6.40661 5.11334 7.99995 5.11334C8.76661 5.11334 9.49328 5.41334 10.0399 5.96001C10.1333 6.05334 10.1866 6.18001 10.1866 6.31334C10.1866 6.44668 10.1333 6.57334 10.0399 6.66668L6.66661 10.04C6.56661 10.14 6.43995 10.1867 6.31328 10.1867ZM7.99995 6.11334C6.95995 6.11334 6.11328 6.96001 6.11328 8.00001C6.11328 8.33334 6.19995 8.65334 6.35995 8.93334L8.93328 6.36001C8.65328 6.20001 8.33328 6.11334 7.99995 6.11334Z"
                fill="#2D2C2C"
              />
              <path
                d="M3.73323 12.34C3.6199 12.34 3.4999 12.3 3.40656 12.22C2.69323 11.6133 2.05323 10.8667 1.50656 10C0.799896 8.9 0.799896 7.10666 1.50656 6C3.13323 3.45333 5.4999 1.98666 7.9999 1.98666C9.46656 1.98666 10.9132 2.49333 12.1799 3.44666C12.3999 3.61333 12.4466 3.92666 12.2799 4.14666C12.1132 4.36666 11.7999 4.41333 11.5799 4.24666C10.4866 3.42 9.24656 2.98666 7.9999 2.98666C5.84656 2.98666 3.78656 4.28 2.34656 6.54C1.84656 7.32 1.84656 8.68 2.34656 9.46C2.84656 10.24 3.4199 10.9133 4.05323 11.46C4.2599 11.64 4.28656 11.9533 4.10656 12.1667C4.01323 12.28 3.87323 12.34 3.73323 12.34Z"
                fill="#2D2C2C"
              />
              <path
                d="M7.99972 14.0133C7.11305 14.0133 6.24638 13.8333 5.41305 13.48C5.15972 13.3733 5.03972 13.08 5.14638 12.8267C5.25305 12.5733 5.54638 12.4533 5.79972 12.56C6.50638 12.86 7.24638 13.0133 7.99305 13.0133C10.1464 13.0133 12.2064 11.72 13.6464 9.45999C14.1464 8.67999 14.1464 7.31999 13.6464 6.53999C13.4397 6.21332 13.213 5.89999 12.973 5.60666C12.7997 5.39332 12.833 5.07999 13.0464 4.89999C13.2597 4.72666 13.573 4.75332 13.753 4.97332C14.013 5.29332 14.2664 5.63999 14.493 5.99999C15.1997 7.09999 15.1997 8.89332 14.493 9.99999C12.8664 12.5467 10.4997 14.0133 7.99972 14.0133Z"
                fill="#2D2C2C"
              />
              <path
                d="M8.45973 10.8467C8.22639 10.8467 8.01306 10.68 7.96639 10.44C7.91306 10.1667 8.09306 9.90665 8.36639 9.85999C9.09973 9.72665 9.71306 9.11332 9.8464 8.37999C9.89973 8.10665 10.1597 7.93332 10.4331 7.97999C10.7064 8.03332 10.8864 8.29332 10.8331 8.56665C10.6197 9.71999 9.69973 10.6333 8.55306 10.8467C8.51973 10.84 8.49306 10.8467 8.45973 10.8467Z"
                fill="#292D32"
              />
              <path
                d="M1.33427 15.1667C1.2076 15.1667 1.08094 15.12 0.980938 15.02C0.787604 14.8267 0.787604 14.5067 0.980938 14.3133L5.96094 9.33332C6.15427 9.13999 6.47427 9.13999 6.6676 9.33332C6.86094 9.52666 6.86094 9.84666 6.6676 10.04L1.6876 15.02C1.5876 15.12 1.46094 15.1667 1.33427 15.1667Z"
                fill="#292D32"
              />
              <path
                d="M9.68583 6.81333C9.55917 6.81333 9.4325 6.76666 9.3325 6.66666C9.13917 6.47333 9.13917 6.15332 9.3325 5.95999L14.3125 0.979991C14.5058 0.786658 14.8258 0.786658 15.0192 0.979991C15.2125 1.17332 15.2125 1.49332 15.0192 1.68666L10.0392 6.66666C9.93917 6.76666 9.8125 6.81333 9.68583 6.81333Z"
                fill="#292D32"
              />
            </svg>
          </button>
        </div>
      </div>
      <div class="form-group">
        <button type="submit" class="submit-btn">Đổi mật khẩu</button>
      </div>
    </form>
  </div>
</template>
  
<script setup>
import { ref } from "vue";
import { useStore } from "vuex";
import { useRouter } from "vue-router";
import Swal from "sweetalert2";
import bcrypt from "bcryptjs";

const store = useStore();
const router = useRouter();

const currentPassword = ref("");
const newPassword = ref("");
const confirmPassword = ref("");

const showCurrentPassword = ref(false);
const showNewPassword = ref(false);
const showConfirmPassword = ref(false);
const loading = ref(false);

const handleChangePassword = async () => {
  try {
    loading.value = true;

    if (newPassword.value !== confirmPassword.value) {
      Swal.fire({
        icon: "error",
        title: "Lỗi",
        text: "Mật khẩu mới không khớp!",
      });
      return;
    }

    const currentUser = store.getters.currentUser;

    const isCurrentPasswordValid = await bcrypt.compare(
      currentPassword.value,
      currentUser.password
    );

    if (!isCurrentPasswordValid) {
      Swal.fire({
        icon: "error",
        title: "Lỗi",
        text: "Mật khẩu hiện tại không đúng!",
      });
      return;
    }

    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(newPassword.value, salt);

    await store.dispatch("updateUser", {
      ...currentUser,
      password: hashedPassword,
      updateAt: new Date().toLocaleDateString(),
    });

    Swal.fire({
      icon: "success",
      title: "Thành công",
      text: "Đổi mật khẩu thành công!",
    }).then(() => {
      router.push("/user/profile");
    });
  } catch (error) {
    console.error("Lỗi khi đổi mật khẩu:", error);
    Swal.fire({
      icon: "error",
      title: "Lỗi",
      text: "Có lỗi xảy ra khi đổi mật khẩu!",
    });
  } finally {
    loading.value = false;
  }
};

const handleCancel = () => {
  router.go(-1);
};
</script>

<style>
.change-password-container {
  margin: 0 auto;
  border-radius: 8px;
  background-color: #fff;
}

.heading {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 16px;
}

.description {
  color: #555;
  margin-bottom: 24px;
  font-size: 14px;
}

.form {
  display: flex;
  flex-direction: column;
}

.form-group {
  margin-bottom: 20px;
}

.label {
  display: block;
  font-size: 14px;
  color: #333;
  margin-bottom: 8px;
}

.input-wrapper {
  position: relative;
}

.input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.input:focus {
  border-color: #2563eb;
  outline: none;
}

.toggle-password-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 16px;
}

.btn {
  padding: 10px 20px;
  font-size: 14px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.cancel-btn {
  background-color: #f5f5f5;
  color: #333;
  transition: background-color 0.2s ease;
}

.cancel-btn:hover {
  background-color: #e0e0e0;
}

.submit-btn {
  padding: 10px 20px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
}

.submit-btn:hover {
  background-color: #0056b3;
}

.submit-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
</style>  